apiVersion: machinelearning.seldon.io/v1
kind: SeldonDeployment
metadata:
  name: risk-churn-scorer-shadow
  namespace: ml-platform
spec:
  name: risk-churn-scorer
  predictors:
  # Primary predictor (v1)
  - name: primary
    replicas: 3
    componentSpecs:
    - spec:
        containers:
        - name: transformer
          image: risk-churn-platform/transformer:latest
          imagePullPolicy: Always
          env:
          - name: MODEL_VERSION
            value: "v1"
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

        - name: model-v1
          image: risk-churn-platform/model:v1
          imagePullPolicy: Always
          env:
          - name: MODEL_PATH
            value: "/models/v1/model.pkl"
          volumeMounts:
          - name: model-storage
            mountPath: /models
          resources:
            requests:
              cpu: "1000m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

        volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: model-pvc

    graph:
      name: transformer
      type: TRANSFORMER
      endpoint:
        type: REST
      children:
      - name: model-v1
        type: MODEL
        endpoint:
          type: REST

  # Shadow predictor (v2) - runs in parallel for comparison
  - name: shadow
    replicas: 2
    shadow: true  # Shadow mode - predictions logged but not returned
    componentSpecs:
    - spec:
        containers:
        - name: transformer
          image: risk-churn-platform/transformer:latest
          imagePullPolicy: Always
          env:
          - name: MODEL_VERSION
            value: "v2"
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"

        - name: model-v2
          image: risk-churn-platform/model:v2
          imagePullPolicy: Always
          env:
          - name: MODEL_PATH
            value: "/models/v2/model.pkl"
          volumeMounts:
          - name: model-storage
            mountPath: /models
          resources:
            requests:
              cpu: "1000m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "2Gi"

        volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: model-pvc

    graph:
      name: transformer
      type: TRANSFORMER
      endpoint:
        type: REST
      children:
      - name: model-v2
        type: MODEL
        endpoint:
          type: REST
